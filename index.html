<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SOAP Note Generator</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2em auto; }
    button { margin: 0.5em 0; padding: 0.6em 1em; font-size: 1em; }
    #status { margin: 0.5em 0; font-weight: bold; }
    pre { background: #f4f4f4; padding: 1em; white-space: pre-wrap; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>SOAP Note Generator</h1>
  <p>Click Start, chat with your patient, then click Stop & Generate.</p>

  <button id="start">Start Recording</button>
  <button id="stop" disabled>Stop & Generate Note</button>
  <div id="status"></div>
  <pre id="output"></pre>

  <script>
    let mediaRecorder, audioChunks;

    document.getElementById('start').onclick = async () => {
      // get mic access
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
      } catch (err) {
        return alert('Mic access denied or not supported');
      }

      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstart = () => {
        document.getElementById('status').textContent = 'Recording…';
        document.getElementById('start').disabled = true;
        document.getElementById('stop').disabled = false;
        document.getElementById('output').textContent = '';
      };

      mediaRecorder.start();
    };

    document.getElementById('stop').onclick = () => {
      mediaRecorder.onstop = async () => {
        document.getElementById('status').textContent = 'Processing…';
        const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
        const form = new FormData();
        form.append('file', blob, 'recording.webm');

        try {
          const resp = await fetch('/api/soapnote', {
            method: 'POST',
            body: form
          });
          const body = await resp.text();
          if (!resp.ok) {
            document.getElementById('output').textContent =
              '❌ Error from server:\n' + body;
          } else {
            document.getElementById('output').textContent = body;
          }
        } catch (e) {
          document.getElementById('output').textContent =
            '⚠️ Fetch failed: ' + e.message;
        }

        document.getElementById('status').textContent = '';
        document.getElementById('start').disabled = false;
        document.getElementById('stop').disabled = true;
      };

      mediaRecorder.stop();
    };
  </script>
</body>
</html>
